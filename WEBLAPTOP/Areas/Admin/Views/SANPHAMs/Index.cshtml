@model IEnumerable<WEBLAPTOP.Models.SANPHAM>

<main class="app-content">
    <div class="app-title">
        <ul class="app-breadcrumb breadcrumb side">
            <li class="breadcrumb-item active"><a href="#"><b>Danh sách sản phẩm</b></a></li>
        </ul>
    </div>

    @*body*@
    <div class="row">
        <div class="col-md-12">
            <div class="tile" style="margin-bottom: 10px;">
                <div class="tile-body">
                    <div style="margin: 0px;">
                        <div class="row element-button">
                            <div class="col-sm-2">
                                <a class="btn btn-add btn-sm" href="@Url.Action("Create", "SANPHAMs")" title="Thêm">
                                    <i class="fa fa-plus"></i> Tạo mới sản phẩm
                                </a>
                            </div>
                            <div class="col-sm-2">
                                <a class="btn btn-delete btn-sm print-file" title="In" onclick="window.print()">
                                    <i class="fa fa-print"></i> In dữ liệu
                                </a>
                            </div>
                            <div class="col-sm-2">
                                <a class="btn btn-excel btn-sm" href="@Url.Action("ExportToExcel", "SANPHAMs")">
                                    <i class="fa fa-file-excel-o"></i> Xuất Excel
                                </a>
                            </div>
                            <div class="col-sm-2">
                                <a class="btn btn-delete btn-sm pdf-file" href="@Url.Action("ExportToPDF", "SANPHAMs")">
                                    <i class="fa fa-file-pdf-o"></i> Xuất PDF
                                </a>
                            </div>

                            <!-- Thanh tìm kiếm bên phải -->
                            <div class="col-sm-6" style="float: right; text-align: right; margin-left: auto;">
                                <form method="get" action="@Url.Action("Index", "SANPHAMs")" style="display: inline-block;">
                                    <div class="input-group">
                                        <input type="text" name="search"
                                               value="@ViewBag.Search"
                                               class="form-control"
                                               placeholder="Tìm kiếm sản phẩm..."
                                               style="width: 250px; border-radius: 4px;">
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>


                    @*div chứa thông tin danh sáhc sản phẩm*@
                    <div style="max-height: 450px; overflow: auto;">
                        <table class="table table-hover table-bordered" id="sampleTable">
                            <thead class="table-light" style="margin: 0px; position: sticky; top: 0px;">
                                <tr style="top: 0px;">
                                    <th style="top: 0px;" width="10"><input type="checkbox" id="all"></th>
                                    <th style="top: 0px;">Mã Sản Phẩm</th>
                                    <th style="top: 0px;">Tên Sản Phẩm</th>
                                    <th style="top: 0px;">Giá</th>
                                    <th style="top: 0px;">Mô tả</th>
                                    <th style="top: 0px;">Hình ảnh</th>
                                    <th style="top: 0px;">Danh mục</th>
                                    <th style="top: 0px;">Số lượng</th>
                                    <th style="top: 0px;">Trạng thái</th>
                                    <th style="top: 0px;">Chức năng</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td><input type="checkbox" name="check1"></td>
                                        <td>@item.MaSP</td>
                                        <td>@item.TenSP</td>
                                        <td>@item.Gia</td>
                                        <td class="one-line" style="max-width: 250px;" title="@item.Mota">
                                            @Html.Raw(item.Mota)
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.Images_url) && item.Images_url != "default.jpg")
                                            {
                                                var arrImages = item.Images_url.Split(';');

                                                <img src="~/Images/Product_images/@arrImages[0]" width="70" height="70" style="object-fit: cover; border: 1px solid #ccc;" />

                                                if (arrImages.Length > 1)
                                                {
                                                    <span class="badge bg-secondary">+@(arrImages.Length - 1)</span>
                                                }
                                            }
                                            else
                                            {
                                                <img src="~/Images/Product_images/default.jpg" width="70" />
                                            }
                                        </td>
                                        <td>@(item.DANHMUC != null ? item.DANHMUC.TenDM : "Không có danh mục")</td>
                                        <td>@item.SoLuong</td>
                                        <td>
                                            @if (item.Status_SP == 1)
                                            {
                                                <span class="badge bg-success">Hiện</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Ẩn</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <a class="btn btn-info btn-sm" title="Chi tiết"
                                               href="@Url.Action("Details", "SANPHAMs", new { id = item.ID_SP })">
                                                <i class="fa fa-eye"></i>
                                            </a>

                                            <button class="btn btn-primary btn-sm trash" type="button" title="Xóa"
                                                    onclick="confirmDelete(@item.ID_SP)">
                                                <i class="fa fa-trash"></i>
                                            </button>

                                            <a class="btn btn-warning btn-sm edit" title="Sửa"
                                               href="@Url.Action("Edit", "SANPHAMs", new { id = item.ID_SP })">
                                                <i class="fa fa-pencil-square-o"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    

                </div>
            </div>
        </div>
    </div>

    @*Phaan trang*@
    <div class="row" style="margin-top: 0px;">
        <div class="col-md-12 d-flex justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination">

                    @* Nút Previous *@
                    <li class="page-item @(ViewBag.Page <= 1 ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.Page - 1 })">«</a>
                    </li>

                    @{
                        int currentPage = ViewBag.Page;
                        int totalPages = ViewBag.TotalPages;
                        int start = Math.Max(1, currentPage - 2);
                        int end = Math.Min(totalPages, currentPage + 2);

                        if (start > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = 1 })">1</a>
                            </li>
                            if (start > 2)
                            {
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            }
                        }

                        for (int i = start; i <= end; i++)
                        {
                            <li class="page-item @(i == currentPage ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = i })">@i</a>
                            </li>
                        }

                        if (end < totalPages)
                        {
                            if (end < totalPages - 1)
                            {
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            }
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = totalPages })">@totalPages</a>
                            </li>
                        }
                    }

                    @* Nút Next *@
                    <li class="page-item @(ViewBag.Page >= ViewBag.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.Page + 1 })">»</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>


</main>

<script>
    function confirmDelete(id) {
        // Dùng cú pháp Swal.fire của SweetAlert 2
        Swal.fire({
            title: "Xác nhận xóa?",
            text: "Bạn có chắc muốn xóa Sản phẩm này không?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            // Kiểm tra xem người dùng có bấm nút "Xóa" (confirm) không
            if (result.isConfirmed) {
                $.ajax({
                    // Giả sử đây là Admin Area, nếu không phải, bỏ 'new { area = "Admin" }'
                    url: '@Url.Action("Delete", "SANPHAMs", new { area = "Admin" })',
                    type: 'POST',
                    data: { id: id },
                    success: function (res) {
                        if (res.success) {
                            Swal.fire({
                                title: "Đã xóa!",
                                text: "Sản phẩm đã được xóa thành công.",
                                icon: "success",
                                timer: 1500,
                                showConfirmButton: false
                            });
                            setTimeout(() => location.reload(), 1000);
                        }
                    },
                    error: function () {
                        Swal.fire({
                            title: "Lỗi!",
                            text: "Không thể xóa sản phẩm. Vui lòng thử lại.",
                            icon: "error",
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                });
            }
        });
    }
    var myApp = new function () {
        this.printTable = function () {
            var tab = document.getElementById('sampleTable');
            var win = window.open('', '', 'height=700,width=700');
            win.document.write(tab.outerHTML);
            win.document.close();
            win.print();
        }
    }
</script>
</body>

<style>

    .one-line {
        white-space: nowrap; /* Không cho xuống dòng */
        overflow: hidden; /* Ẩn phần thừa */
        text-overflow: ellipsis; /* Thêm dấu ... vào cuối */
    }

        /* Quan trọng: Xử lý thẻ <p> của Summernote bên trong */
        .one-line * {
            display: inline !important; /* Biến thẻ p thành thẻ thường để không bị xuống dòng */
            margin: 0 !important; /* Xóa khoảng cách dòng thừa */
            padding: 0 !important;
        }

/*Text elipssia*/


    /* Giảm chiều rộng bảng tổng thể */
    #sampleTable {
        width: 100%; /* bạn có thể chỉnh 50% hoặc 70% tùy ý */
        margin-left: 0; /* canh trái */
    }

        /* Thu nhỏ riêng cột chức năng */
        #sampleTable th:last-child,
        #sampleTable td:last-child {
            width: 150px; /* Giảm xuống 100px nếu muốn gọn hơn */
            text-align: center; /* Căn giữa các nút */
        }

    /* Nút gọn gàng hơn */
    .btn-primary.btn-sm,
    .btn-warning.btn-sm {
        min-width: 35px;
        height: 32px;
    }

    @@media print {
        /* Ẩn các thành phần không cần thiết khi in */
        .app-header, .app-sidebar, .app-title, .element-button, .tile-footer, .btn {
            display: none !important;
        }
        /* Căn chỉnh bảng để in đẹp hơn */
        .tile {
            box-shadow: none;
            border: none;
        }
        body {
            background-color: white;
        }
    }
    .one-line {
        white-space: nowrap; /* Không cho xuống dòng */
        overflow: hidden; /* Ẩn phần thừa */
        text-overflow: ellipsis; /* Thêm dấu ... vào cuối */
    }

        /* Quan trọng: Xử lý thẻ <p> của Summernote bên trong */
        .one-line * {
            display: inline !important; /* Biến thẻ p thành thẻ thường để không bị xuống dòng */
            margin: 0 !important; /* Xóa khoảng cách dòng thừa */
            padding: 0 !important;
        }
</style>


