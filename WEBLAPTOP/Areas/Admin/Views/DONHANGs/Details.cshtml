@model WEBLAPTOP.Models.DONHANG

<main class="app-content">
    <div class="app-title">
        <ul class="app-breadcrumb breadcrumb side">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "DONHANGs")"><b>Danh sách đơn hàng</b></a></li>
            <li class="breadcrumb-item active"><a href="#">Chi tiết đơn hàng</a></li>
        </ul>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="tile">
                <h3 class="tile-title">Thông tin chi tiết đơn hàng</h3>
                <div class="tile-body">

                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="mb-3">Thông tin người nhận</h4>
                            <hr />
                            <p>
                                <strong>Tên người nhận:</strong>
                                @Html.DisplayFor(model => model.Ten)
                            </p>
                            <p>
                                <strong>Số điện thoại:</strong>
                                @Html.DisplayFor(model => model.SDT)
                            </p>
                            <p>
                                <strong>Địa chỉ giao hàng:</strong>
                                @Html.DisplayFor(model => model.DiaChiGiaoHang)
                            </p>
                            <p>
                                <strong>Ghi chú:</strong>
                                @(string.IsNullOrEmpty(Model.GhiChu) ? "Không có ghi chú." : Model.GhiChu)
                            </p>
                        </div>

                        <div class="col-md-6">
                            <h4 class="mb-3">Thông tin đơn hàng</h4>
                            <hr />
                            <p>
                                <strong>Khách hàng (Tài khoản):</strong>
                                @(Model.KHACHHANG != null ? Model.KHACHHANG.TenKH : "Không có tên khách hàng")
                            </p>
                            <p>
                                <strong>Ngày lập:</strong>
                                @(Model.NgayLap.HasValue ? Model.NgayLap.Value.ToString("dd/MM/yyyy") : "Không rõ")
                            </p>
                            <p>
                                <strong>Trạng thái:</strong>
                                @if (Model.TrangThai == "Đã giao")
                                {
                                    <span class="badge bg-success">Đã giao</span>
                                }
                                else if (Model.TrangThai == "Đang giao")
                                {
                                    <span class="badge bg-info">Đang giao</span>
                                }
                                else if (Model.TrangThai == "Đã huỷ")
                                {
                                    <span class="badge bg-danger">Đã huỷ</span>
                                }
                                else if (Model.TrangThai == "Đang xác nhận")
                                {
                                    <span class="badge bg-warning">Đang xác nhận</span>
                                }
                                else
                                {
                                    @Html.DisplayFor(model => model.TrangThai)
                                }
                            </p>
                            <p>
                                <strong>Phương thức thanh toán:</strong>
                                @Html.DisplayFor(model => model.PhuongthucTT)
                            </p>
                            <p>
                                <strong>Phương thức nhận hàng:</strong>
                                @Html.DisplayFor(model => model.PhuongThucNhanHang)
                            </p>
                            <p>
                                <strong>Khuyến mãi áp dụng:</strong>
                                @(Model.KHUYENMAI != null ? Model.KHUYENMAI.Mota : "Không áp dụng")
                            </p>
                        </div>
                        <hr class="mt-4" /> <h4 class="mt-4 mb-3">Chi tiết sản phẩm đã mua</h4>
                        <table class="table table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Tên sản phẩm</th>
                                    <th class="text-center" width="100">Số lượng</th>
                                    <th class="text-end" width="150">Đơn giá</th>
                                    <th class="text-end" width="150">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.DONHANG_SANPHAM)
                                {
                                    <tr>
                                        <td>
                                            @(item.SANPHAM != null ? item.SANPHAM.TenSP : "Sản phẩm không tồn tại")
                                        </td>
                                        <td class="text-center">
                                            @(item.SoLuong ?? 0)
                                        </td>
                                        <td class="text-end">
                                            @((item.DonGia ?? 0).ToString("N0")) đ
                                        </td>
                                        <td class="text-end">
                                            @(((item.SoLuong ?? 0) * (item.DonGia ?? 0)).ToString("N0")) đ
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                @{
                                    // 1. Tính tổng tiền hàng (Tạm tính)
                                    long tongTienHang = Model.DONHANG_SANPHAM.Sum(item => (long)(item.SoLuong ?? 0) * (item.DonGia ?? 0));

                                    // 2. Xử lý giảm giá (Thông minh hơn)
                                    long tienGiam = 0;
                                    string loaiGiam = ""; // Để hiển thị text cho rõ (VD: -10% hay -50.000đ)

                                    if (Model.KHUYENMAI != null && Model.KHUYENMAI.GiamGia.HasValue)
                                    {
                                        int giaTriGiam = Model.KHUYENMAI.GiamGia.Value;

                                        // --- LOGIC QUAN TRỌNG Ở ĐÂY ---
                                        if (giaTriGiam <= 100)
                                        {
                                            // Trường hợp Phần Trăm (<= 100)
                                            // Công thức: Tổng tiền * Phần Trăm / 100
                                            tienGiam = (tongTienHang * giaTriGiam) / 100;
                                            loaiGiam = $"{giaTriGiam}%";
                                        }
                                        else
                                        {
                                            // Trường hợp Tiền Mặt (> 100)
                                            tienGiam = giaTriGiam;
                                            loaiGiam = string.Format("{0:N0} đ", giaTriGiam);
                                        }

                                        // Đảm bảo không giảm quá số tiền hàng (tránh bị âm tiền)
                                        if (tienGiam > tongTienHang) { tienGiam = tongTienHang; }
                                    }

                                    // 3. Tính tổng thanh toán cuối cùng
                                    long tongThanhToan = tongTienHang - tienGiam;
                                }

                                <tr>
                                    <td colspan="3" class="text-end"><strong>Tạm tính:</strong></td>
                                    <td class="text-end">
                                        @tongTienHang.ToString("N0") đ
                                    </td>
                                </tr>

                                @if (Model.KHUYENMAI != null)
                                {
                                    <tr>
                                        <td colspan="3" class="text-end" style="color: red;">
                                            <strong>Khuyến mãi (@Model.KHUYENMAI.Mota):</strong>
                                            <span class="badge bg-danger">Giảm @loaiGiam</span>
                                        </td>
                                        <td class="text-end" style="color: red;">
                                            -@tienGiam.ToString("N0") đ
                                        </td>
                                    </tr>
                                }

                                <tr style="background-color: #fff3cd;">
                                    <th colspan="3" class="text-end h5">Khách phải trả:</th>
                                    <th class="text-end h5 text-success">
                                        @tongThanhToan.ToString("N0") đ
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="tile-footer">
                    <a class="btn btn-warning" href="@Url.Action("Edit", "DONHANGs", new { id = Model.ID_DH })">
                        <i class="fa fa-pencil-square-o"></i> Chỉnh sửa
                    </a>

                    &nbsp;&nbsp;&nbsp;

                    <a class="btn btn-success" target="_blank" href="@Url.Action("ExportInvoice", "DONHANGs", new { id = Model.ID_DH })">
                        <i class="fa fa-print"></i> In hóa đơn
                    </a>

                    &nbsp;&nbsp;&nbsp;

                    <a class="btn btn-secondary" href="@Url.Action("Index", "DONHANGs")">
                        <i class="fa fa-arrow-left"></i> Quay lại danh sách
                    </a>
                </div>
            </div>
        </div>
    </div>
</main>