@model WEBLAPTOP.Models.DONHANG

<main class="app-content">
    <div class="app-title">
        <ul class="app-breadcrumb breadcrumb side">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "DONHANGs")"><b>Danh sách đơn hàng</b></a></li>
            <li class="breadcrumb-item active"><a href="#">Chi tiết đơn hàng</a></li>
        </ul>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="tile">
                <h3 class="tile-title">Thông tin chi tiết đơn hàng</h3>
                <div class="tile-body">

                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="mb-3">Thông tin người nhận</h4>
                            <hr />
                            <p>
                                <strong>Tên người nhận:</strong>
                                @Html.DisplayFor(model => model.Ten)
                            </p>
                            <p>
                                <strong>Số điện thoại:</strong>
                                @Html.DisplayFor(model => model.SDT)
                            </p>
                            <p>
                                <strong>Địa chỉ giao hàng:</strong>
                                @Html.DisplayFor(model => model.DiaChiGiaoHang)
                            </p>
                            <p>
                                <strong>Ghi chú:</strong>
                                @(string.IsNullOrEmpty(Model.GhiChu) ? "Không có ghi chú." : Model.GhiChu)
                            </p>
                        </div>

                        <div class="col-md-6">
                            <h4 class="mb-3">Thông tin đơn hàng</h4>
                            <hr />
                            <p>
                                <strong>Khách hàng (Tài khoản):</strong>
                                @(Model.KHACHHANG != null ? Model.KHACHHANG.TenKH : "Không có tên khách hàng")
                            </p>
                            <p>
                                <strong>Ngày lập:</strong>
                                @(Model.NgayLap.HasValue ? Model.NgayLap.Value.ToString("dd/MM/yyyy") : "Không rõ")
                            </p>
                            <p>
                                <strong>Trạng thái:</strong>
                                @if (Model.TrangThai == "Đã giao")
                                {
                                    <span class="badge bg-success">Đã giao</span>
                                }
                                else if (Model.TrangThai == "Đang giao")
                                {
                                    <span class="badge bg-info">Đang giao</span>
                                }
                                else if (Model.TrangThai == "Đã huỷ")
                                {
                                    <span class="badge bg-danger">Đã huỷ</span>
                                }
                                else if (Model.TrangThai == "Đang xác nhận")
                                {
                                    <span class="badge bg-warning">Đang xác nhận</span>
                                }
                                else
                                {
                                    @Html.DisplayFor(model => model.TrangThai)
                                }
                            </p>
                            <p>
                                <strong>Phương thức thanh toán:</strong>
                                @Html.DisplayFor(model => model.PhuongthucTT)
                            </p>
                            <p>
                                <strong>Phương thức nhận hàng:</strong>
                                @Html.DisplayFor(model => model.PhuongThucNhanHang)
                            </p>
                            <p>
                                <strong>Khuyến mãi áp dụng:</strong>
                                @(Model.KHUYENMAI != null ? Model.KHUYENMAI.Mota : "Không áp dụng")
                            </p>
                        </div>
                        <hr class="mt-4" /> <h4 class="mt-4 mb-3">Chi tiết sản phẩm đã mua</h4>
                        <table class="table table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Tên sản phẩm</th>
                                    <th class="text-center" width="100">Số lượng</th>
                                    <th class="text-end" width="150">Đơn giá</th>
                                    <th class="text-end" width="150">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.DONHANG_SANPHAM)
                                {
                                    <tr>
                                        <td>
                                            @(item.SANPHAM != null ? item.SANPHAM.TenSP : "Sản phẩm không tồn tại")
                                        </td>
                                        <td class="text-center">
                                            @(item.SoLuong ?? 0)
                                        </td>
                                        <td class="text-end">
                                            @((item.DonGia ?? 0).ToString("N0")) đ
                                        </td>
                                        <td class="text-end">
                                            @(((item.SoLuong ?? 0) * (item.DonGia ?? 0)).ToString("N0")) đ
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-end">Tổng tiền hàng</th>
                                    <th class="text-end h5">
                                        @{
                                            // SỬA LỖI Ở ĐÂY: Xử lý null cho cả 2 biến trước khi Sum
                                            var tongTien = Model.DONHANG_SANPHAM.Sum(item => (long)(item.SoLuong ?? 0) * (item.DonGia ?? 0));
                                        }
                                        @tongTien.ToString("N0") đ
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="tile-footer">
                    <a class="btn btn-warning" href="@Url.Action("Edit", "DONHANGs", new { id = Model.ID_DH })">
                        <i class="fa fa-pencil-square-o"></i> Chỉnh sửa
                    </a>
                    &nbsp;&nbsp;&nbsp;
                    <a class="btn btn-secondary" href="@Url.Action("Index", "DONHANGs")">
                        <i class="fa fa-arrow-left"></i> Quay lại danh sách
                    </a>
                </div>
            </div>
        </div>
    </div>
</main>